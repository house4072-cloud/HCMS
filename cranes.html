<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="icon" href="favicon.ico?v=2" sizes="any">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HCMS | 소형크레인 리스트</title>
  <link rel="stylesheet" href="assets/hcms.css">
  <style>
  /* ✅ 워터마크가 안 보일 때 강제 적용 패치 */
  body{ position: relative; }

  body::before{
    content:"";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;

    background-image: url("assets/watermark_hope.png");
    background-repeat: no-repeat;
    background-position: center;
    background-size: 520px auto;
    opacity: 0.06;
  }

  /* ✅ 표/카드가 워터마크 위로 오게 */
  .topbar, .container, main, .card, .table-wrap, table{
    position: relative;
    z-index: 1;
  }
</style>

</head>

<body>

<header class="topbar">
  <img src="assets/hope.png" alt="희망이엔지">
  <div class="title">소형크레인 리스트</div>
  <img src="assets/hanwha.png" alt="한화에너지">
</header>

<main class="container">

  <section class="card">
    <h2>필터</h2>
<div class="btn-row" style="margin:12px 0; gap:10px; display:flex; flex-wrap:wrap;">
  <button class="btn" onclick="printFiltered_cranes()">필터결과 프린트</button>
  <button class="btn" onclick="printSelected_cranes()">선택 프린트</button>
  <button class="btn ghost" onclick="selectAllRows_cranes(true)">전체 선택</button>
  <button class="btn ghost" onclick="selectAllRows_cranes(false)">선택 해제</button>
</div>

    <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:14px;">
      <select id="f_no_mode" class="input" onchange="applyNoModeFilterUI()">
        <option value="">번호구분 전체</option>
        <option value="input">번호입력</option>
        <option value="none">번호없음</option>
      </select>

      <input id="f_no" class="input" placeholder="크레인 번호 (예: C-014)" />

      <select id="f_area" class="input">
        <option value="">지역 전체</option>
        <option value="A">A</option>
        <option value="B">B</option>
      </select>

      <select id="f_type" class="input">
        <option value="">타입 전체</option>
        <option value="EOT">EOT</option>
        <option value="Suspension">Suspension</option>
        <option value="Gantry">Gantry</option>
        <option value="Post">Post</option>
        <option value="Wall">Wall</option>
        <option value="Monorail">Monorail</option>
        <option value="Service Crane">Service Crane</option>
      </select>

      <input id="f_brand" class="input" placeholder="브랜드" />
      <input id="f_ton" class="input" placeholder="톤수" />

      <select id="f_status" class="input">
        <option value="">상태 전체</option>
        <option value="완료">완료</option>
        <option value="보류">보류</option>
        <option value="미완">미완</option>
        <option value="미점검">미점검</option>
      </select>
    </div>

    <button class="btn" onclick="loadCranes()">필터 적용</button>

    <style>
      @media (max-width:900px){
        .card > div{ grid-template-columns:1fr!important; }
      }
    </style>
  </section>

  <section class="card">
    <h2>크레인 등록</h2>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
      <select id="c_no_mode" class="input" style="max-width:220px;" onchange="setNoMode()">
        <option value="input">번호입력</option>
        <option value="none">번호없음</option>
      </select>
      <div style="color:#6b7280;font-weight:700;display:flex;align-items:center;">
        번호입력: 숫자만 치면 C- 자동 / 번호없음: “번호없음” 저장
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:12px;">
      <input id="c_no" class="input" placeholder="크레인 번호(숫자만 가능)" onblur="autoCraneNoPrefix()" />

      <select id="c_area" class="input">
        <option value="">지역 선택</option>
        <option value="A">A</option>
        <option value="B">B</option>
      </select>

      <select id="c_type" class="input">
        <option value="">크레인 타입 선택</option>
        <option value="EOT">EOT</option>
        <option value="Suspension">Suspension</option>
        <option value="Gantry">Gantry</option>
        <option value="Post">Post</option>
        <option value="Wall">Wall</option>
        <option value="Monorail">Monorail</option>
        <option value="Service Crane">Service Crane</option>
      </select>

      <input id="c_brand" class="input" placeholder="브랜드" />
      <input id="c_ton" class="input" placeholder="톤수" />
      <input id="c_group" class="input" placeholder="그룹" />
    </div>

    <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:12px;">
      <select id="c_hoist_type" class="input" onchange="toggleHoistDetail()">
        <option value="">호이스트 타입</option>
        <option value="Wire">Wire</option>
        <option value="Chain">Chain</option>
      </select>

      <input id="c_wire_dia" class="input" placeholder="와이어 Φ (숫자)" style="display:none;" />
      <input id="c_wire_len" class="input" placeholder="와이어 길이 M (숫자)" style="display:none;" />

      <select id="c_reeving" class="input" style="display:none;">
        <option value="">싱글/더블</option>
        <option value="Single">Single</option>
        <option value="Double">Double</option>
      </select>

      <div></div><div></div>
    </div>

    <button class="btn" onclick="addCrane()">크레인 등록/수정 저장</button>

    <style>
      @media (max-width:900px){
        section.card > div{ grid-template-columns:1fr!important; }
      }
    </style>
  </section>

  <section class="card">
    <h2>리스트</h2>
    <table>
      <thead>
        <tr>
          <th>번호</th>
          <th>지역</th>
          <th>타입</th>
          <th>브랜드</th>
          <th>톤수</th>
          <th>호이스트</th>
          <th>그룹</th>
          <th>상태</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody id="craneList"></tbody>
    </table>
  </section>

</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="app.js"></script>

<script>
  function setNoMode() {
    const mode = document.getElementById("c_no_mode")?.value;
    const no = document.getElementById("c_no");
    if (!no) return;

    if (mode === "none") {
      no.value = "번호없음";
      no.readOnly = true;
      no.style.background = "#f3f4f6";
    } else {
      if (no.value === "번호없음") no.value = "";
      no.readOnly = false;
      no.style.background = "";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    setNoMode();
  });
</script>
<script>
/* =========================
   cranes.html 프린트 패치 (app.js 수정 X)
========================= */
(function(){
  const TABLE_ID = "craneTable";
  const TITLE_FILTER = "HCMS 소형크레인 리스트 (필터결과)";
  const TITLE_SELECTED = (n)=>`HCMS 소형크레인 리스트 (선택 ${n}건)`;

  function _getTable(){
    return document.getElementById(TABLE_ID) || document.querySelector("table");
  }
  function _getTbody(){
    const t=_getTable(); return t ? t.querySelector("tbody") : null;
  }

  function ensureCheckboxes(){
    const table=_getTable(), tbody=_getTbody();
    if(!table || !tbody) return;

    let thead = table.querySelector("thead");
    if(!thead){
      thead=document.createElement("thead");
      table.insertBefore(thead, table.firstChild);
      const tr=document.createElement("tr");
      const colCount=(tbody.querySelector("tr")?.children?.length||1);
      for(let i=0;i<colCount;i++){ const th=document.createElement("th"); th.textContent=""; tr.appendChild(th); }
      thead.appendChild(tr);
    }

    const headRow = thead.querySelector("tr");
    if(headRow){
      const firstTH=headRow.children[0];
      if(firstTH && !firstTH.querySelector("#printChkAll_cranes")){
        firstTH.innerHTML = `<input id="printChkAll_cranes" type="checkbox" onchange="selectAllRows_cranes(this.checked)" />`;
      }
    }

    [...tbody.querySelectorAll("tr")].forEach(tr=>{
      const firstTD=tr.children[0];
      if(!firstTD) return;
      if(firstTD.querySelector && firstTD.querySelector("input.rowChk_cranes")) return;

      const td=document.createElement("td");
      td.style.width="60px";
      td.innerHTML=`<input type="checkbox" class="rowChk_cranes" />`;
      tr.insertBefore(td, tr.firstChild);
    });
  }

  window.selectAllRows_cranes = function(checked){
    const tbody=_getTbody(); if(!tbody) return;
    tbody.querySelectorAll("input.rowChk_cranes").forEach(chk=>chk.checked=!!checked);
    const all=document.getElementById("printChkAll_cranes");
    if(all) all.checked=!!checked;
  }

  function _stripColumns(cloneTable){
    // 체크박스 칸 + '관리' 칸 숨김 (프린트용)
    const ths=[...cloneTable.querySelectorAll("thead th")];
    let manageIdx = -1;
    ths.forEach((th,i)=>{
      const t=(th.textContent||"").trim();
      if(t==="관리" || t.toLowerCase()==="actions") manageIdx=i;
    });

    function removeCol(idx){
      if(idx<0) return;
      cloneTable.querySelectorAll("tr").forEach(tr=>{
        if(tr.children[idx]) tr.children[idx].remove();
      });
    }

    // 0번(체크) 제거
    removeCol(0);
    // 관리 칸 제거 (체크칸 제거 후 인덱스가 1 줄어듦)
    if(manageIdx>=0) removeCol(manageIdx-1);
  }

  function _buildPrintHTML(title, tableHTML){
    const now=new Date();
    const stamp=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")} ${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;

    return `<!doctype html><html lang="ko"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${title}</title>
<style>
body{font-family:Arial,sans-serif;margin:24px;color:#111;}
.hdr{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:14px;}
.hdr .t{font-size:20px;font-weight:900;}
.hdr .d{font-size:12px;color:#666;font-weight:700;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#f2f2f2;font-weight:900;}
</style></head><body>
<div class="hdr"><div class="t">${title}</div><div class="d">${stamp}</div></div>
${tableHTML}
</body></html>`;
  }

  function _openPrint(html){
    const w=window.open("","_blank");
    w.document.open(); w.document.write(html); w.document.close();
    w.focus(); w.print();
  }

  window.printFiltered_cranes = function(){
    ensureCheckboxes();
    const table=_getTable(); if(!table) return alert("표(table)를 찾지 못했습니다.");

    const clone=table.cloneNode(true);
    _stripColumns(clone);

    _openPrint(_buildPrintHTML(TITLE_FILTER, clone.outerHTML));
  }

  window.printSelected_cranes = function(){
    ensureCheckboxes();
    const table=_getTable(), tbody=_getTbody();
    if(!table||!tbody) return alert("표(table)를 찾지 못했습니다.");

    const selected=[...tbody.querySelectorAll("tr")].filter(tr=>tr.querySelector("input.rowChk_cranes")?.checked);
    if(selected.length===0) return alert("선택된 항목이 없습니다.");

    const cloneTable=table.cloneNode(false);
    const thead=table.querySelector("thead")?.cloneNode(true);
    const newTbody=document.createElement("tbody");
    selected.forEach(tr=>newTbody.appendChild(tr.cloneNode(true)));

    if(thead) cloneTable.appendChild(thead);
    cloneTable.appendChild(newTbody);

    _stripColumns(cloneTable);

    _openPrint(_buildPrintHTML(TITLE_SELECTED(selected.length), cloneTable.outerHTML));
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    ensureCheckboxes();
    const tbody=_getTbody(); if(!tbody) return;
    const obs=new MutationObserver(()=>ensureCheckboxes());
    obs.observe(tbody,{childList:true,subtree:true});
  });
})();
</script>

</body>
</html>
 
