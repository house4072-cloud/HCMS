<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="icon" href="favicon.ico?v=2" sizes="any">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HCMS | 타워크레인 리스트</title>

  <!-- 공용 CSS -->
  <link rel="stylesheet" href="assets/hcms.css">
<style>
  /* ✅ 워터마크가 안 보일 때 강제 적용 패치 */
  body{ position: relative; }

  body::before{
    content:"";
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;

    background-image: url("assets/watermark_hope.png");
    background-repeat: no-repeat;
    background-position: center;
    background-size: 520px auto;
    opacity: 0.06;
  }

  /* ✅ 표/카드가 워터마크 위로 오게 */
  .topbar, .container, main, .card, .table-wrap, table{
    position: relative;
    z-index: 1;
  }
</style>

</head>

<body>

<header class="topbar">
  <img src="assets/hope.png" alt="희망이엔지">
  <div class="title">타워크레인 리스트</div>
  <img src="assets/hanwha.png" alt="한화에너지">
</header>

<main class="container">

  <!-- ===== 필터 (타워는 번호없음 없음) ===== -->
  <section class="card">
    <h2>필터</h2>
    <div class="btn-row" style="margin:12px 0; gap:10px; display:flex; flex-wrap:wrap;">
  <button class="btn" onclick="printFiltered_tower()">필터결과 프린트</button>
  <button class="btn" onclick="printSelected_tower()">선택 프린트</button>
  <button class="btn ghost" onclick="selectAllRows_tower(true)">전체 선택</button>
  <button class="btn ghost" onclick="selectAllRows_tower(false)">선택 해제</button>
</div>

    <div class="form-grid">
      <input id="f_no" class="input" placeholder="크레인 번호 (예: TC-203 또는 203)" />
      <select id="f_area" class="input">
        <option value="">지역 전체</option>
        <option value="A">A</option>
        <option value="B">B</option>
      </select>
      <input id="f_brand" class="input" placeholder="브랜드" />
      <input id="f_ton" class="input" placeholder="톤수" />
      <select id="f_status" class="input">
        <option value="">상태 전체</option>
        <option value="완료">완료</option>
        <option value="보류">보류</option>
        <option value="미완">미완</option>
        <option value="미점검">미점검</option>
      </select>
      <button class="btn" onclick="loadTowerCranes()">필터 적용</button>
    </div>
  </section>

  <!-- ===== 등록 ===== -->
  <section class="card">
    <h2>타워크레인 등록</h2>
    <div class="form-grid">
      <input id="c_no" class="input" placeholder="번호 (숫자만 → TC-자동)" onblur="autoTowerNoPrefix()" />
      <select id="c_area" class="input">
        <option value="">지역 선택</option>
        <option value="A">A</option>
        <option value="B">B</option>
      </select>
      <input id="c_brand" class="input" placeholder="브랜드" />
      <input id="c_ton" class="input" placeholder="톤수" />
      <input id="c_wire" class="input" placeholder="와이어 파이 (숫자)" />
      <input id="c_trolley" class="input" placeholder="트롤리 파이 (숫자)" />
    </div>

    <button class="btn" onclick="addTowerCrane()">타워크레인 등록/수정 저장</button>
  </section>

  <!-- ===== 리스트 ===== -->
  <section class="card">
    <h2>리스트</h2>
    <table>
      <thead>
        <tr>
          <th>번호</th>
          <th>지역</th>
          <th>브랜드</th>
          <th>톤수</th>
          <th>와이어</th>
          <th>트롤리</th>
          <th>상태</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody id="towerCraneList"></tbody>
    </table>
  </section>

</main>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ✅ tower_cranes.html은 app.js 함수에 의존하지 않게 "자체 동작"으로 고침
  const SUPABASE_URL = "https://lzfksuiftgmxwkhwhnhg.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6ZmtzdWlmdGdteHdraHdobmhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3NzczMDMsImV4cCI6MjA4MTM1MzMwM30.BHI8dTc18Jw3akhlRL7OZ8_0sYQwjb0-QaMGjKjUfYA";
  const sb_tower = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let editingTowerId = null;

  function autoTowerNoPrefix() {
    const el = document.getElementById("c_no");
    if (!el) return;
    let v = (el.value || "").trim();
    if (!v) return;

    // 이미 TC-면 패스
    if (v.toUpperCase().startsWith("TC-")) return;

    // 숫자만이면 TC- 자동
    if (/^\d+$/.test(v)) el.value = `TC-${v}`;
  }

  function _parseWireTrolley(hoistSpec) {
    // 저장형식: "WIRE:10;TROLLEY:12" (없으면 빈값)
    const out = { wire: "", trolley: "" };
    if (!hoistSpec) return out;
    const parts = String(hoistSpec).split(";");
    parts.forEach(p => {
      const [k, v] = p.split(":");
      if (!k) return;
      if (k.trim().toUpperCase() === "WIRE") out.wire = (v || "").trim();
      if (k.trim().toUpperCase() === "TROLLEY") out.trolley = (v || "").trim();
    });
    return out;
  }

  function _makeHoistSpec(wire, trolley) {
    const w = (wire || "").trim();
    const t = (trolley || "").trim();
    const wv = w ? `WIRE:${w}` : `WIRE:`;
    const tv = t ? `TROLLEY:${t}` : `TROLLEY:`;
    return `${wv};${tv}`;
  }

  async function loadTowerCranes() {
    let query = sb_tower.from("cranes").select("*").eq("crane_type", "타워");

    const noRaw = document.getElementById("f_no")?.value?.trim();
    const area = document.getElementById("f_area")?.value || "";
    const brand = document.getElementById("f_brand")?.value?.trim() || "";
    const ton = document.getElementById("f_ton")?.value?.trim() || "";
    const status = document.getElementById("f_status")?.value || "";

    // 번호: 숫자만이면 TC- 붙여서 검색
    let no = noRaw || "";
    if (no && /^\d+$/.test(no)) no = `TC-${no}`;
    if (no) query = query.ilike("crane_no", `%${no}%`);

    if (area) query = query.eq("area", area);
    if (brand) query = query.ilike("brand", `%${brand}%`);
    if (ton) query = query.eq("ton", Number(ton));
    if (status) query = query.eq("inspection_status", status);

    const { data, error } = await query.order("crane_no", { ascending: true });
    if (error) return alert(error.message);

    const tbody = document.getElementById("towerCraneList");
    tbody.innerHTML = "";

    (data || []).forEach(c => {
      const wt = _parseWireTrolley(c.hoist_spec);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.crane_no || ""}</td>
        <td>${c.area || ""}</td>
        <td>${c.brand || ""}</td>
        <td>${c.ton ?? ""}</td>
        <td>${wt.wire || ""}</td>
        <td>${wt.trolley || ""}</td>
        <td>${c.inspection_status || ""}</td>
        <td>
          ${
            c.inspection_status === "보류"
              ? `<button class="btn-mini gray" onclick="releaseTowerHold('${c.id}')">해제</button>`
              : `<button class="btn-mini orange" onclick="setTowerHold('${c.id}')">보류</button>`
          }
          <button class="btn-mini gray" onclick="loadTowerToForm('${c.id}')">수정</button>
          <button class="btn-mini warn" onclick="deleteTower('${c.id}')">삭제</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function addTowerCrane() {
    let crane_no = document.getElementById("c_no")?.value?.trim();
    if (!crane_no) return alert("타워크레인 번호 필수");

    // 숫자만 입력하면 TC- 자동
    if (/^\d+$/.test(crane_no)) crane_no = `TC-${crane_no}`;
    if (!crane_no.toUpperCase().startsWith("TC-")) {
      return alert("타워크레인 번호는 TC- 로 시작해야 합니다. (예: TC-203)");
    }

    const area = document.getElementById("c_area")?.value || null;
    const brand = document.getElementById("c_brand")?.value?.trim() || null;

    const tonRaw = document.getElementById("c_ton")?.value?.trim();
    const ton = tonRaw ? Number(tonRaw) : null;

    const wire = document.getElementById("c_wire")?.value?.trim() || "";
    const trolley = document.getElementById("c_trolley")?.value?.trim() || "";

    // ✅ 단위 자동 느낌(표시용): 숫자만 받되 저장은 숫자 그대로
    if (wire && !/^\d+(\.\d+)?$/.test(wire)) return alert("와이어 파이는 숫자만 입력");
    if (trolley && !/^\d+(\.\d+)?$/.test(trolley)) return alert("트롤리 파이는 숫자만 입력");

    const payload = {
      crane_no,
      crane_type: "타워",
      area,
      brand,
      ton,
      hoist_type: "Tower",
      hoist_spec: _makeHoistSpec(wire, trolley)
    };

    const res = editingTowerId
      ? await sb_tower.from("cranes").update(payload).eq("id", editingTowerId)
      : await sb_tower.from("cranes").insert(payload);

    if (res.error) return alert(res.error.message);

    alert(editingTowerId ? "수정 완료" : "등록 완료");
    editingTowerId = null;

    // 입력 초기화
    ["c_no","c_area","c_brand","c_ton","c_wire","c_trolley"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });

    loadTowerCranes();
  }

  async function loadTowerToForm(id) {
    const { data, error } = await sb_tower.from("cranes").select("*").eq("id", id).single();
    if (error || !data) return alert(error?.message || "데이터 없음");

    editingTowerId = id;

    document.getElementById("c_no").value = data.crane_no || "";
    document.getElementById("c_area").value = data.area || "";
    document.getElementById("c_brand").value = data.brand || "";
    document.getElementById("c_ton").value = data.ton ?? "";

    const wt = _parseWireTrolley(data.hoist_spec);
    document.getElementById("c_wire").value = wt.wire || "";
    document.getElementById("c_trolley").value = wt.trolley || "";
  }

  async function deleteTower(id) {
    if (!confirm("정말 삭제할까요?")) return;
    const { error } = await sb_tower.from("cranes").delete().eq("id", id);
    if (error) return alert(error.message);
    loadTowerCranes();
  }

  async function setTowerHold(id) {
    const reason = prompt("보류 사유");
    if (!reason) return;

    const { error } = await sb_tower.from("cranes").update({
      inspection_status: "보류",
      hold_reason: reason
    }).eq("id", id);

    if (error) return alert(error.message);
    loadTowerCranes();
  }

  async function releaseTowerHold(id) {
    const { error } = await sb_tower.from("cranes").update({
      inspection_status: "미완료",
      hold_reason: null
    }).eq("id", id);

    if (error) return alert(error.message);
    loadTowerCranes();
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadTowerCranes();
  });
</script>
<script>
/* =========================
   tower_cranes.html 프린트 패치 (app.js 수정 X)
========================= */
(function(){
  const TABLE_ID = "towerTable";
  const TITLE_FILTER = "HCMS 타워크레인 리스트 (필터결과)";
  const TITLE_SELECTED = (n)=>`HCMS 타워크레인 리스트 (선택 ${n}건)`;

  function _getTable(){ return document.getElementById(TABLE_ID) || document.querySelector("table"); }
  function _getTbody(){ const t=_getTable(); return t ? t.querySelector("tbody") : null; }

  function ensureCheckboxes(){
    const table=_getTable(), tbody=_getTbody();
    if(!table||!tbody) return;

    let thead=table.querySelector("thead");
    if(!thead){
      thead=document.createElement("thead");
      table.insertBefore(thead, table.firstChild);
      const tr=document.createElement("tr");
      const colCount=(tbody.querySelector("tr")?.children?.length||1);
      for(let i=0;i<colCount;i++){ const th=document.createElement("th"); th.textContent=""; tr.appendChild(th); }
      thead.appendChild(tr);
    }

    const headRow=thead.querySelector("tr");
    if(headRow){
      const firstTH=headRow.children[0];
      if(firstTH && !firstTH.querySelector("#printChkAll_tower")){
        firstTH.innerHTML=`<input id="printChkAll_tower" type="checkbox" onchange="selectAllRows_tower(this.checked)" />`;
      }
    }

    [...tbody.querySelectorAll("tr")].forEach(tr=>{
      const firstTD=tr.children[0];
      if(!firstTD) return;
      if(firstTD.querySelector && firstTD.querySelector("input.rowChk_tower")) return;

      const td=document.createElement("td");
      td.style.width="60px";
      td.innerHTML=`<input type="checkbox" class="rowChk_tower" />`;
      tr.insertBefore(td, tr.firstChild);
    });
  }

  window.selectAllRows_tower = function(checked){
    const tbody=_getTbody(); if(!tbody) return;
    tbody.querySelectorAll("input.rowChk_tower").forEach(chk=>chk.checked=!!checked);
    const all=document.getElementById("printChkAll_tower");
    if(all) all.checked=!!checked;
  }

  function _stripColumns(cloneTable){
    const ths=[...cloneTable.querySelectorAll("thead th")];
    let manageIdx=-1;
    ths.forEach((th,i)=>{
      const t=(th.textContent||"").trim();
      if(t==="관리" || t.toLowerCase()==="actions") manageIdx=i;
    });

    function removeCol(idx){
      if(idx<0) return;
      cloneTable.querySelectorAll("tr").forEach(tr=>{
        if(tr.children[idx]) tr.children[idx].remove();
      });
    }

    removeCol(0); // 체크칸 제거
    if(manageIdx>=0) removeCol(manageIdx-1);
  }

  function _buildPrintHTML(title, tableHTML){
    const now=new Date();
    const stamp=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")} ${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
    return `<!doctype html><html lang="ko"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${title}</title>
<style>
body{font-family:Arial,sans-serif;margin:24px;color:#111;}
.hdr{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:14px;}
.hdr .t{font-size:20px;font-weight:900;}
.hdr .d{font-size:12px;color:#666;font-weight:700;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#f2f2f2;font-weight:900;}
</style></head><body>
<div class="hdr"><div class="t">${title}</div><div class="d">${stamp}</div></div>
${tableHTML}
</body></html>`;
  }

  function _openPrint(html){
    const w=window.open("","_blank");
    w.document.open(); w.document.write(html); w.document.close();
    w.focus(); w.print();
  }

  window.printFiltered_tower = function(){
    ensureCheckboxes();
    const table=_getTable(); if(!table) return alert("표(table)를 찾지 못했습니다.");
    const clone=table.cloneNode(true);
    _stripColumns(clone);
    _openPrint(_buildPrintHTML(TITLE_FILTER, clone.outerHTML));
  }

  window.printSelected_tower = function(){
    ensureCheckboxes();
    const table=_getTable(), tbody=_getTbody();
    if(!table||!tbody) return alert("표(table)를 찾지 못했습니다.");

    const selected=[...tbody.querySelectorAll("tr")].filter(tr=>tr.querySelector("input.rowChk_tower")?.checked);
    if(selected.length===0) return alert("선택된 항목이 없습니다.");

    const cloneTable=table.cloneNode(false);
    const thead=table.querySelector("thead")?.cloneNode(true);
    const newTbody=document.createElement("tbody");
    selected.forEach(tr=>newTbody.appendChild(tr.cloneNode(true)));
    if(thead) cloneTable.appendChild(thead);
    cloneTable.appendChild(newTbody);

    _stripColumns(cloneTable);
    _openPrint(_buildPrintHTML(TITLE_SELECTED(selected.length), cloneTable.outerHTML));
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    ensureCheckboxes();
    const tbody=_getTbody(); if(!tbody) return;
    const obs=new MutationObserver(()=>ensureCheckboxes());
    obs.observe(tbody,{childList:true,subtree:true});
  });
})();
</script>

</body>
</html>
