<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HCMS | 타워크레인 리스트</title>

  <!-- 공용 CSS -->
  <link rel="stylesheet" href="assets/hcms.css">

</head>

<body>

<header class="topbar">
  <img src="assets/hope.png" alt="희망이엔지">
  <div class="title">타워크레인 리스트</div>
  <img src="assets/hanwha.png" alt="한화에너지">
</header>

<main class="container">

  <!-- ===== 필터 (타워는 번호없음 없음) ===== -->
  <section class="card">
    <h2>필터</h2>
    <div class="form-grid">
      <input id="f_no" class="input" placeholder="크레인 번호 (예: TC-203 또는 203)" />
      <select id="f_area" class="input">
        <option value="">지역 전체</option>
        <option value="A">A</option>
        <option value="B">B</option>
      </select>
      <input id="f_brand" class="input" placeholder="브랜드" />
      <input id="f_ton" class="input" placeholder="톤수" />
      <select id="f_status" class="input">
        <option value="">상태 전체</option>
        <option value="완료">완료</option>
        <option value="보류">보류</option>
        <option value="미완">미완</option>
        <option value="미점검">미점검</option>
      </select>
      <button class="btn" onclick="loadTowerCranes()">필터 적용</button>
    </div>
  </section>

  <!-- ===== 등록 ===== -->
  <section class="card">
    <h2>타워크레인 등록</h2>
    <div class="form-grid">
      <input id="c_no" class="input" placeholder="번호 (숫자만 → TC-자동)" onblur="autoTowerNoPrefix()" />
      <select id="c_area" class="input">
        <option value="">지역 선택</option>
        <option value="A">A</option>
        <option value="B">B</option>
      </select>
      <input id="c_brand" class="input" placeholder="브랜드" />
      <input id="c_ton" class="input" placeholder="톤수" />
      <input id="c_wire" class="input" placeholder="와이어 파이 (숫자)" />
      <input id="c_trolley" class="input" placeholder="트롤리 파이 (숫자)" />
    </div>

    <button class="btn" onclick="addTowerCrane()">타워크레인 등록/수정 저장</button>
  </section>

  <!-- ===== 리스트 ===== -->
  <section class="card">
    <h2>리스트</h2>
    <table>
      <thead>
        <tr>
          <th>번호</th>
          <th>지역</th>
          <th>브랜드</th>
          <th>톤수</th>
          <th>와이어</th>
          <th>트롤리</th>
          <th>상태</th>
          <th>관리</th>
        </tr>
      </thead>
      <tbody id="towerCraneList"></tbody>
    </table>
  </section>

</main>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // ✅ tower_cranes.html은 app.js 함수에 의존하지 않게 "자체 동작"으로 고침
  const SUPABASE_URL = "https://lzfksuiftgmxwkhwhnhg.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx6ZmtzdWlmdGdteHdraHdobmhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3NzczMDMsImV4cCI6MjA4MTM1MzMwM30.BHI8dTc18Jw3akhlRL7OZ8_0sYQwjb0-QaMGjKjUfYA";
  const sb_tower = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let editingTowerId = null;

  function autoTowerNoPrefix() {
    const el = document.getElementById("c_no");
    if (!el) return;
    let v = (el.value || "").trim();
    if (!v) return;

    // 이미 TC-면 패스
    if (v.toUpperCase().startsWith("TC-")) return;

    // 숫자만이면 TC- 자동
    if (/^\d+$/.test(v)) el.value = `TC-${v}`;
  }

  function _parseWireTrolley(hoistSpec) {
    // 저장형식: "WIRE:10;TROLLEY:12" (없으면 빈값)
    const out = { wire: "", trolley: "" };
    if (!hoistSpec) return out;
    const parts = String(hoistSpec).split(";");
    parts.forEach(p => {
      const [k, v] = p.split(":");
      if (!k) return;
      if (k.trim().toUpperCase() === "WIRE") out.wire = (v || "").trim();
      if (k.trim().toUpperCase() === "TROLLEY") out.trolley = (v || "").trim();
    });
    return out;
  }

  function _makeHoistSpec(wire, trolley) {
    const w = (wire || "").trim();
    const t = (trolley || "").trim();
    const wv = w ? `WIRE:${w}` : `WIRE:`;
    const tv = t ? `TROLLEY:${t}` : `TROLLEY:`;
    return `${wv};${tv}`;
  }

  async function loadTowerCranes() {
    let query = sb_tower.from("cranes").select("*").eq("crane_type", "타워");

    const noRaw = document.getElementById("f_no")?.value?.trim();
    const area = document.getElementById("f_area")?.value || "";
    const brand = document.getElementById("f_brand")?.value?.trim() || "";
    const ton = document.getElementById("f_ton")?.value?.trim() || "";
    const status = document.getElementById("f_status")?.value || "";

    // 번호: 숫자만이면 TC- 붙여서 검색
    let no = noRaw || "";
    if (no && /^\d+$/.test(no)) no = `TC-${no}`;
    if (no) query = query.ilike("crane_no", `%${no}%`);

    if (area) query = query.eq("area", area);
    if (brand) query = query.ilike("brand", `%${brand}%`);
    if (ton) query = query.eq("ton", Number(ton));
    if (status) query = query.eq("inspection_status", status);

    const { data, error } = await query.order("crane_no", { ascending: true });
    if (error) return alert(error.message);

    const tbody = document.getElementById("towerCraneList");
    tbody.innerHTML = "";

    (data || []).forEach(c => {
      const wt = _parseWireTrolley(c.hoist_spec);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.crane_no || ""}</td>
        <td>${c.area || ""}</td>
        <td>${c.brand || ""}</td>
        <td>${c.ton ?? ""}</td>
        <td>${wt.wire || ""}</td>
        <td>${wt.trolley || ""}</td>
        <td>${c.inspection_status || ""}</td>
        <td>
          ${
            c.inspection_status === "보류"
              ? `<button class="btn-mini gray" onclick="releaseTowerHold('${c.id}')">해제</button>`
              : `<button class="btn-mini orange" onclick="setTowerHold('${c.id}')">보류</button>`
          }
          <button class="btn-mini gray" onclick="loadTowerToForm('${c.id}')">수정</button>
          <button class="btn-mini warn" onclick="deleteTower('${c.id}')">삭제</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function addTowerCrane() {
    let crane_no = document.getElementById("c_no")?.value?.trim();
    if (!crane_no) return alert("타워크레인 번호 필수");

    // 숫자만 입력하면 TC- 자동
    if (/^\d+$/.test(crane_no)) crane_no = `TC-${crane_no}`;
    if (!crane_no.toUpperCase().startsWith("TC-")) {
      return alert("타워크레인 번호는 TC- 로 시작해야 합니다. (예: TC-203)");
    }

    const area = document.getElementById("c_area")?.value || null;
    const brand = document.getElementById("c_brand")?.value?.trim() || null;

    const tonRaw = document.getElementById("c_ton")?.value?.trim();
    const ton = tonRaw ? Number(tonRaw) : null;

    const wire = document.getElementById("c_wire")?.value?.trim() || "";
    const trolley = document.getElementById("c_trolley")?.value?.trim() || "";

    // ✅ 단위 자동 느낌(표시용): 숫자만 받되 저장은 숫자 그대로
    if (wire && !/^\d+(\.\d+)?$/.test(wire)) return alert("와이어 파이는 숫자만 입력");
    if (trolley && !/^\d+(\.\d+)?$/.test(trolley)) return alert("트롤리 파이는 숫자만 입력");

    const payload = {
      crane_no,
      crane_type: "타워",
      area,
      brand,
      ton,
      hoist_type: "Tower",
      hoist_spec: _makeHoistSpec(wire, trolley)
    };

    const res = editingTowerId
      ? await sb_tower.from("cranes").update(payload).eq("id", editingTowerId)
      : await sb_tower.from("cranes").insert(payload);

    if (res.error) return alert(res.error.message);

    alert(editingTowerId ? "수정 완료" : "등록 완료");
    editingTowerId = null;

    // 입력 초기화
    ["c_no","c_area","c_brand","c_ton","c_wire","c_trolley"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = "";
    });

    loadTowerCranes();
  }

  async function loadTowerToForm(id) {
    const { data, error } = await sb_tower.from("cranes").select("*").eq("id", id).single();
    if (error || !data) return alert(error?.message || "데이터 없음");

    editingTowerId = id;

    document.getElementById("c_no").value = data.crane_no || "";
    document.getElementById("c_area").value = data.area || "";
    document.getElementById("c_brand").value = data.brand || "";
    document.getElementById("c_ton").value = data.ton ?? "";

    const wt = _parseWireTrolley(data.hoist_spec);
    document.getElementById("c_wire").value = wt.wire || "";
    document.getElementById("c_trolley").value = wt.trolley || "";
  }

  async function deleteTower(id) {
    if (!confirm("정말 삭제할까요?")) return;
    const { error } = await sb_tower.from("cranes").delete().eq("id", id);
    if (error) return alert(error.message);
    loadTowerCranes();
  }

  async function setTowerHold(id) {
    const reason = prompt("보류 사유");
    if (!reason) return;

    const { error } = await sb_tower.from("cranes").update({
      inspection_status: "보류",
      hold_reason: reason
    }).eq("id", id);

    if (error) return alert(error.message);
    loadTowerCranes();
  }

  async function releaseTowerHold(id) {
    const { error } = await sb_tower.from("cranes").update({
      inspection_status: "미완료",
      hold_reason: null
    }).eq("id", id);

    if (error) return alert(error.message);
    loadTowerCranes();
  }

  document.addEventListener("DOMContentLoaded", () => {
    loadTowerCranes();
  });
</script>

</body>
</html>
